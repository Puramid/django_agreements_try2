{% extends 'base.html' %} 
{% load humanize %} 
{% block title %}{{ view.object|default:"Новый портфель" }}{% endblock %} 
{% block content %} 
<div class="container mt-4">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      <div class="card">
        <div class="card-header">
          <h4>
            {% if view.object %} 
              Редактирование портфеля: <span id="portfolio-label-preview" 
                data-creditor="{{ view.object.agreement.creditor }}"
                data-agreement-type="{{ view.object.agreement.get_agreement_type_display }}"
                data-date-placement="{{ view.object.date_placement|date:'Y-m-d' }}"
                data-process-type="{{ view.object.get_process_type_display }}">{{ view.object.label|default:"Без названия" }}</span> 
            {% else %} 
              Новый портфель: <span id="portfolio-label-preview">Без названия</span> 
            {% endif %}
          </h4>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data" id="portfolio-form">
            {% csrf_token %} 
            {% for field in form %} 
              {% if field.name != 'label_preview' %} 
                <div class="mb-3">
                  <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label> 
                  {% if field.name == 'total_sum' %} 
                    <div class="input-group">
                      {{ field }} 
                      <span class="input-group-text">₽</span>
                    </div>
                  {% else %} 
                    {{ field }} 
                  {% endif %} 
                  {% if field.help_text %} 
                    <div class="form-text">{{ field.help_text }}</div>
                  {% endif %} 
                  {% if field.errors %} 
                    <div class="invalid-feedback d-block">{{ field.errors|join:", " }}</div>
                  {% endif %} 
                  {# Показываем текущее значение для дат при редактировании #} 
                  {% if view.object and field.name in 'date_placement,date_finish,cession_date' %} 
                    <div class="form-text">Текущее значение: 
                      {% if field.name == 'date_placement' and view.object.date_placement %} 
                        {{ view.object.date_placement|date:"d.m.Y" }} 
                      {% elif field.name == 'date_finish' and view.object.date_finish %} 
                        {{ view.object.date_finish|date:"d.m.Y" }} 
                      {% elif field.name == 'cession_date' and view.object.cession_date %} 
                        {{ view.object.cession_date|date:"d.m.Y" }} 
                      {% endif %} 
                    </div>
                  {% endif %} 
                </div>
              {% endif %} 
            {% endfor %} 
            
            {# Поле для предварительного просмотра имени портфеля #}
            <div class="mb-3">
              <label for="id_label_preview" class="form-label">Имя портфеля (итог)</label>
              <input type="text" class="form-control-plaintext" id="id_label_preview" readonly>
            </div>
            
            {# --- скрытое поле для agreement при создании портфеля --- #} 
            {% if 'portfolio' in request.path and 'new' in request.path %} 
              <input type="hidden" name="agreement" value="{{ view.kwargs.agreement_pk }}">
              <!-- Скрытые поля для динамического имени портфеля -->
              <input type="hidden" id="agreement-creditor" value="{{ agreement.creditor }}">
              <input type="hidden" id="agreement-type" value="{{ agreement.get_agreement_type_display }}">
            {% endif %} 
            
            {# --- кнопки --- #} 
            <div class="d-flex justify-content-between">
              <button type="submit" class="btn btn-primary">
                {% if view.object %}Сохранить{% else %}Создать{% endif %}
              </button>
              <a href="{% url 'deals:dashboard' %}" class="btn btn-secondary">Отмена</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

{# --- скрипт для динамического расчёта label_preview --- #}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Поля, влияющие на имя портфеля
  const datePlacementField = document.querySelector('#id_date_placement');
  const processTypeField = document.querySelector('#id_process_type');
  const labelPreview = document.querySelector('#id_label_preview');
  const portfolioLabelPreview = document.querySelector('#portfolio-label-preview');
  
  // Получаем данные договора
  let creditor, agreementType;
  
  // Для нового портфеля берем из скрытых полей
  if (document.querySelector('#agreement-creditor')) {
    creditor = document.querySelector('#agreement-creditor').value;
    agreementType = document.querySelector('#agreement-type').value;
  } 
  // Для существующего портфеля берем из data-атрибутов
  else if (portfolioLabelPreview) {
    creditor = portfolioLabelPreview.getAttribute('data-creditor');
    agreementType = portfolioLabelPreview.getAttribute('data-agreement-type');
  }
  
  // Функция обновления имени портфеля
  function updatePortfolioLabel() {
    if (!datePlacementField || !processTypeField || !creditor || !agreementType) return;
    
    // Получаем значения полей
    let datePlacement;
    if (datePlacementField.value) {
      datePlacement = new Date(datePlacementField.value).toLocaleDateString('ru-RU');
    } else if (portfolioLabelPreview && portfolioLabelPreview.getAttribute('data-date-placement')) {
      datePlacement = new Date(portfolioLabelPreview.getAttribute('data-date-placement')).toLocaleDateString('ru-RU');
    } else {
      datePlacement = '';
    }
    
    let processType;
    if (processTypeField.value) {
      processType = processTypeField.options[processTypeField.selectedIndex].text;
    } else if (portfolioLabelPreview && portfolioLabelPreview.getAttribute('data-process-type')) {
      processType = portfolioLabelPreview.getAttribute('data-process-type');
    } else {
      processType = '';
    }
    
    // Формируем новое имя
    const newLabel = `${creditor}_${agreementType}_${datePlacement}_${processType}`;
    
    // Обновляем отображаемое имя в поле формы
    if (labelPreview) {
      labelPreview.value = newLabel;
    }
    
    // Обновляем отображаемое имя в заголовке
    if (portfolioLabelPreview) {
      portfolioLabelPreview.textContent = newLabel;
      
      // Добавляем эффект подсветки при изменении
      portfolioLabelPreview.style.transition = 'all 0.3s ease';
      portfolioLabelPreview.style.backgroundColor = '#e7f1ff';
      setTimeout(() => {
        portfolioLabelPreview.style.backgroundColor = 'transparent';
      }, 500);
    }
  }
  
  // Добавляем обработчики событий
  if (datePlacementField) {
    datePlacementField.addEventListener('change', updatePortfolioLabel);
    datePlacementField.addEventListener('input', updatePortfolioLabel);
  }
  if (processTypeField) {
    processTypeField.addEventListener('change', updatePortfolioLabel);
  }
  
  // Инициализация при загрузке
  updatePortfolioLabel();
});
</script>
{% endblock %}
