{% extends 'base.html' %} 
{% load static humanize custom_filters %} 
{% load query_transform %} 
{% block title %}ECOI{% endblock %} 
{% block content %} 
{% if messages %} 
{% for message in messages %} 
<div class="alert alert-info">{{ message }}</div> 
{% endfor %} 
{% endif %} 

<div class="dashboard-container">
  <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –°–ø–∏—Å–æ–∫ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ -->
  <div class="agreements-panel">
    <div class="panel-header">
      <h3>–î–æ–≥–æ–≤–æ—Ä—ã</h3>
      <a href="{% url 'deals:agreement-new' %}" class="btn btn-primary btn-sm">+ –ù–æ–≤—ã–π</a>
    </div>
    
    <div class="agreements-list">
      {% for a in agreements %}
      <div class="agreement-item {% if a == current_agreement %}active{% endif %}" data-agreement-id="{{ a.id }}">
        <div class="agreement-main">
          <div class="agreement-info">
            <div class="agreement-code">{{ a.agreement_code }}</div>
            <div class="agreement-meta">
              <!-- –î–æ–±–∞–≤–ª–µ–Ω ID –¥–æ–≥–æ–≤–æ—Ä–∞ –ª–µ–≤–µ–µ –∫—Ä–µ–¥–∏—Ç–æ—Ä–∞ -->
              <span class="agreement-id">ID: {{ a.id }}</span>
              <span class="creditor-name">{{ a.creditor }}</span>
              <span>{{ a.agreement_date|date:"d.m.Y" }}</span>
              <span>{{ a.get_agreement_type_display }}</span>
              <span class="financial-info">–°—É–º–º–∞: {{ a.total_sum|currency_format }}</span>
              <span class="financial-info">–°—Ç–æ–∏–º–æ—Å—Ç—å: {{ a.total_amount|currency_format }}</span>
            </div>
          </div>
          <div class="agreement-actions">
            <a href="?agreement={{ a.id }}" class="view-btn">üëÅ</a>
            <a href="{% url 'deals:agreement-edit' a.id %}" class="edit-btn">‚úé</a>
            <a href="{% url 'deals:agreement-delete' a.id %}" class="delete-btn">üóë</a>
          </div>
        </div>
        
        <!-- –°–∫—Ä—ã—Ç—ã–π –±–ª–æ–∫ —Å –¥–µ—Ç–∞–ª—è–º–∏ -->
        <div class="agreement-details" id="details-{{ a.id }}">
          <div class="detail-row">
            <strong>–ö–æ–¥ –¥–æ–≥–æ–≤–æ—Ä–∞:</strong> {{ a.agreement_code }}
          </div>
          <div class="detail-row">
            <strong>ID –¥–æ–≥–æ–≤–æ—Ä–∞:</strong> {{ a.id }}
          </div>
          <div class="detail-row">
            <strong>–î–∞—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞:</strong> {{ a.agreement_date|date:"d.m.Y" }}
          </div>
          <div class="detail-row">
            <strong>–¢–∏–ø –¥–æ–≥–æ–≤–æ—Ä–∞:</strong> {{ a.get_agreement_type_display }}
          </div>
          <div class="detail-row">
            <strong>–ö—Ä–µ–¥–∏—Ç–æ—Ä:</strong> {{ a.creditor }}
          </div>
          {% if a.creditor_first %}
          <div class="detail-row">
            <strong>–ü–µ—Ä–≤. –∫—Ä–µ–¥–∏—Ç–æ—Ä:</strong> {{ a.creditor_first }}
          </div>
          {% endif %}
          <div class="detail-row">
            <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—è:</strong> {{ a.total_sum|currency_format }}
          </div>
          <div class="detail-row">
            <strong>–†–∞–∑–º–µ—Ä –ø–æ—Ä—Ç—Ñ–µ–ª—è:</strong> {{ a.total_amount|currency_format }}
          </div>
          {% if a.agreement_doc %}
          <div class="detail-row">
            <strong>–î–æ–∫—É–º–µ–Ω—Ç:</strong> <a href="{{ a.agreement_doc.url }}">üìé –°–∫–∞—á–∞—Ç—å</a>
          </div>
          {% endif %}
        </div>
      </div>
      {% empty %}
      <div class="no-data">–ù–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–æ–≤</div>
      {% endfor %}
    </div>
  </div>

  <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –ü–æ—Ä—Ç—Ñ–µ–ª–∏ -->
  <div class="portfolios-panel">
    <div class="panel-header">
      <h3>–ü–æ—Ä—Ç—Ñ–µ–ª–∏ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É ‚Ññ{{ current_agreement.id|default:"" }}</h3>
      {% if current_agreement %}
      <a href="{% url 'deals:portfolio-new' current_agreement.id %}" class="btn btn-primary btn-sm">+ –ü–æ—Ä—Ç—Ñ–µ–ª—å</a>
      {% endif %}
    </div>
    
    <div class="portfolios-list">
      {% if current_agreement %}
      {% for p in current_agreement.portfolio_set.all %}
      <div class="portfolio-item">
        <div class="portfolio-header">
          <div class="portfolio-title">{{ p.label|default:"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }}</div>
          <div class="portfolio-actions">
            <a href="{% url 'deals:portfolio-edit' p.id %}" class="edit-btn">‚úé</a>
            <a href="{% url 'deals:portfolio-delete' p.id %}" class="delete-btn">üóë</a>
          </div>
        </div>
        
        <div class="portfolio-info">
          <div class="info-row">
            <span>ID:</span> {{ p.id }}
          </div>
          <div class="info-row">
            <span>–¢–∏–ø:</span> {{ p.get_type_display }}
          </div>
          <div class="info-row">
            <span>–°—É–º–º–∞:</span> {{ p.total_sum|currency_format }}
          </div>
          <div class="info-row">
            <span>–°—Ç–∞—Ä—Ç:</span> {{ p.date_placement|date:"d.m.Y" }}
          </div>
          {% if p.date_finish %}
          <div class="info-row">
            <span>–û–∫–æ–Ω—á–∞–Ω–∏–µ:</span> {{ p.date_finish|date:"d.m.Y" }}
          </div>
          {% endif %}
        </div>
        
        <button class="toggle-details" data-target="portfolio-details-{{ p.id }}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
        
        <div id="portfolio-details-{{ p.id }}" class="portfolio-details" style="display: none;">
          <div class="detail-row">
            <strong>ID:</strong> {{ p.id }}
          </div>
          <div class="detail-row">
            <strong>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</strong> {{ p.label|default:"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }}
          </div>
          <div class="detail-row">
            <strong>–¢–∏–ø:</strong> {{ p.get_type_display }}
          </div>
          <div class="detail-row">
            <strong>–¢–∏–ø —Ä–∞–±–æ—Ç—ã:</strong> {{ p.get_process_type_display }}
          </div>
          <div class="detail-row">
            <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> {{ p.total_sum|currency_format }}
          </div>
          <div class="detail-row">
            <strong>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</strong> {{ p.date_placement|date:"d.m.Y" }}
          </div>
          {% if p.date_finish %}
          <div class="detail-row">
            <strong>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</strong> {{ p.date_finish|date:"d.m.Y" }}
          </div>
          {% endif %}
          {% if p.cession_date %}
          <div class="detail-row">
            <strong>–î–∞—Ç–∞ –ø–µ—Ä–µ—É—Å—Ç—É–ø–∫–∏:</strong> {{ p.cession_date|date:"d.m.Y" }}
          </div>
          {% endif %}
        </div>
      </div>
      {% empty %}
      <div class="no-data">–ù–µ—Ç –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π</div>
      {% endfor %}
      {% else %}
      <div class="no-data">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–≥–æ–≤–æ—Ä —Å–ª–µ–≤–∞</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}