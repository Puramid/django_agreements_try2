{% extends 'base.html' %}
{% load static %}
{% load query_transform %}

{% block title %}ECOI{% endblock %}

{% block content %}
<style>
  .clickable-row {
      cursor: pointer;
      position: relative;
  }
  .clickable-row a::before {
      content: "";
      position: absolute;
      left: 0; top: 0; right: 0; bottom: 0;
  }

  .clickable-card {
      position: relative;
      cursor: pointer;
  }
  .clickable-card a::before {
      content: "";
      position: absolute;
      left: 0; top: 0; right: 0; bottom: 0;
      z-index: 1;
  }

  .edit-btn {
      position: relative;
      z-index: 2;
  }

  .sort-col a { text-decoration: none; color: inherit; }
  .sort-col.asc  a::after  { content: " ▲"; }
  .sort-col.desc a::after  { content: " ▼"; }
</style>

<div class="d-flex gap-3" style="min-height:100vh;">
  <!-- ЛЕВАЯ ПАНЕЛЬ -->
  <div class="flex-fill bg-white rounded shadow-sm p-3" style="overflow:auto;max-width:700px;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Договоры</h5>
      <a class="btn btn-sm btn-primary" href="{% url 'deals:agreement-new' %}">+ Новый</a>
    </div>

    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th class="sort-col {% if current_sort == 'id' %}{{ current_dir }}{% endif %}">
            <a href="?{% query_transform sort='id' dir=rev_dir agreement=request.GET.agreement %}">ID</a>
          </th>
          <th class="sort-col {% if current_sort == 'agreement_code' %}{{ current_dir }}{% endif %}">
            <a href="?{% query_transform sort='agreement_code' dir=rev_dir agreement=request.GET.agreement %}">Код</a>
          </th>
          <th class="sort-col {% if current_sort == 'agreement_date' %}{{ current_dir }}{% endif %}">
            <a href="?{% query_transform sort='agreement_date' dir=rev_dir agreement=request.GET.agreement %}">Дата</a>
          </th>
          <th class="sort-col {% if current_sort == 'agreement_type' %}{{ current_dir }}{% endif %}">
            <a href="?{% query_transform sort='agreement_type' dir=rev_dir agreement=request.GET.agreement %}">Тип</a>
          </th>
          <th class="sort-col {% if current_sort == 'creditor' %}{{ current_dir }}{% endif %}">
            <a href="?{% query_transform sort='creditor' dir=rev_dir agreement=request.GET.agreement %}">Кредитор</a>
          </th>
          <th class="sort-col {% if current_sort == 'total_sum' %}{{ current_dir }}{% endif %}">
            <a href="?{% query_transform sort='total_sum' dir=rev_dir agreement=request.GET.agreement %}">Сумма</a>
          </th>
          <th style="width:76px;"></th>
        </tr>
      </thead>
      <tbody>
      {% for a in agreements %}
        <tr class="clickable-row {% if current_agreement and a.id == current_agreement.id %}table-primary{% endif %}">
          <td><a href="?{% query_transform agreement=a.id %}">{{ a.id }}</a></td>
          <td><a href="?{% query_transform agreement=a.id %}">{{ a.agreement_code }}</a></td>
          <td><a href="?{% query_transform agreement=a.id %}">{{ a.agreement_date|date:"d.m.Y" }}</a></td>
          <td><a href="?{% query_transform agreement=a.id %}">{{ a.get_agreement_type_display }}</a></td>
          <td><a href="?{% query_transform agreement=a.id %}">{{ a.creditor }}</a></td>
          <td><a href="?{% query_transform agreement=a.id %}">{{ a.total_sum|floatformat:2 }}</a></td>
          <td>
            <a class="btn btn-sm btn-outline-secondary edit-btn" href="{% url 'deals:agreement-edit' a.pk %}">✎</a>
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="7" class="text-center">Нет договоров</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ПРАВАЯ ПАНЕЛЬ: портфели -->
  <div class="flex-fill bg-white rounded shadow-sm p-3" style="overflow:auto;">
    {% if current_agreement %}
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>Портфели по договору №{{ current_agreement.id }}</h5>
        <a class="btn btn-sm btn-success" href="{% url 'deals:portfolio-new' current_agreement.pk %}">+ Портфель</a>
      </div>

      {% for p in current_agreement.portfolio_set.all %}
        <div class="card mb-3 clickable-card">
          <div class="card-body d-flex justify-content-between">
            <div>
              <h6 class="card-title mb-1">
                <a href="{% url 'deals:portfolio-edit' p.pk %}">{{ p.label }}</a>
              </h6>
              <span class="badge bg-info text-dark">{{ p.get_type_display }}</span>
              <div class="mt-1 small text-muted">
                Сумма: {{ p.total_sum|floatformat:2 }} ₽<br>
                Старт: {{ p.date_placement|date:"d.m.Y" }}
                {% if p.date_finish %}<br>Финиш: {{ p.date_finish|date:"d.m.Y" }}{% endif %}
              </div>
            </div>
            <a class="btn btn-sm btn-outline-primary edit-btn" href="{% url 'deals:portfolio-edit' p.pk %}">✎</a>
          </div>
        </div>
      {% empty %}
        <p class="text-muted">Нет портфелей</p>
      {% endfor %}
    {% else %}
      <p class="text-muted">Выберите договор слева</p>
    {% endif %}
  </div>
</div>

{% endblock %}