{% extends 'base.html' %}
{% load static humanize custom_filters %}
{% load query_transform %}

{% block title %}ECOI{% endblock %}

{% block content %}
<style>
  /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä 2:1 */
  .dashboard-container {
      display: flex;
      gap: 1rem;
      min-height: 100vh;
  }
  
  .panel-left {
      flex: 2;
      max-width: calc(66.67% - 0.5rem);
  }
  
  .panel-right {
      flex: 1;
      max-width: calc(33.33% - 0.5rem);
  }

  /* –ö–û–†–†–ï–ö–¢–ò–†–û–í–ö–ê –®–ò–†–ò–ù–´ –ö–û–õ–û–ù–û–ö */
  /* –ë—ã–ª–æ: ID 80px, –ö—Ä–µ–¥–∏—Ç–æ—Ä auto (–ø—Ä–∏–º–µ—Ä–Ω–æ 150-200px) */
  /* –°—Ç–∞–ª–æ: –ö—Ä–µ–¥–∏—Ç–æ—Ä / 2.5, ID + —ç—Ç–æ –∂–µ –∑–Ω–∞—á–µ–Ω–∏–µ */
  .id-column {
      width: 440px !important; /* –ë—ã–ª–æ 80px + 40px –æ—Ç –∫—Ä–µ–¥–∏—Ç–æ—Ä–∞ */
      min-width: 440px !important;
  }
  
  .creditor-column {
      width: 300px !important; /* –ë—ã–ª–æ –ø—Ä–∏–º–µ—Ä–Ω–æ 150px / 2.5 = 60px */
      min-width: 300px !important;
  }

  /* –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–æ–µ –æ–∫–Ω–æ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
  .expandable-window {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-out;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin: 10px 0;
      width: 100%;
      box-sizing: border-box;
  }
  .expandable-window.show {
      max-height: 1000px;
      padding: 20px;
      width: calc(100% - 20px);
      margin-left: -10px;
      margin-right: -10px;
  }

  /* –ö—É—Ä—Å–æ—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π */
  .double-click-row {
      cursor: pointer;
  }
  .double-click-row:hover {
      background-color: rgba(0,123,255,0.1);
  }
  .single-click-header {
      cursor: pointer;
  }
  .single-click-header:hover {
      background-color: rgba(0,123,255,0.1);
  }

  .expand-toggle {
      cursor: pointer;
      color: #007bff;
      font-size: 0.85em;
      text-decoration: underline;
      margin-left: 5px;
  }

  /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
  .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e9ecef;
  }
  .detail-label {
      font-weight: 600;
      color: #495057;
      min-width: 120px;
  }
  .detail-value {
      color: #212529;
      text-align: right;
      flex: 1;
  }
  .currency-format {
      white-space: nowrap;
  }

  /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
  @media (max-width: 768px) {
      .dashboard-container {
          flex-direction: column;
      }
      .panel-left,
      .panel-right {
          max-width: 100%;
      }
  }

  /* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ */
  .table th,
  .table td {
      padding: 0.5rem;
      font-size: 0.875rem;
      vertical-align: middle;
  }
</style>

<!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
{% if messages %}
  <div style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<div class="dashboard-container">
  <!-- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨: –î–æ–≥–æ–≤–æ—Ä—ã (2/3 —à–∏—Ä–∏–Ω—ã) -->
  <div class="panel-left">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">–î–æ–≥–æ–≤–æ—Ä—ã</h5>
      <a class="btn btn-sm btn-primary" href="{% url 'deals:agreement-new' %}">+ –ù–æ–≤—ã–π</a>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th class="sort-col {% if current_sort == 'id' %}{{ current_dir }}{% endif %} id-column" style="width:120px;">
              <a href="?{% query_transform sort='id' dir=rev_dir agreement=request.GET.agreement %}">ID</a>
            </th>
            <th class="sort-col {% if current_sort == 'agreement_code' %}{{ current_dir }}{% endif %}">
              <a href="?{% query_transform sort='agreement_code' dir=rev_dir agreement=request.GET.agreement %}">–ö–æ–¥</a>
            </th>
            <th class="sort-col {% if current_sort == 'agreement_date' %}{{ current_dir }}{% endif %}" style="width:80px;">
              <a href="?{% query_transform sort='agreement_date' dir=rev_dir agreement=request.GET.agreement %}">–î–∞—Ç–∞</a>
            </th>
            <th class="sort-col {% if current_sort == 'agreement_type' %}{{ current_dir }}{% endif %}" style="width:80px;">
              <a href="?{% query_transform sort='agreement_type' dir=rev_dir agreement=request.GET.agreement %}">–¢–∏–ø</a>
            </th>
            <th class="sort-col {% if current_sort == 'creditor' %}{{ current_dir }}{% endif %} creditor-column" style="width:60px;">
              <a href="?{% query_transform sort='creditor' dir=rev_dir agreement=request.GET.agreement %}">–ö—Ä–µ–¥–∏—Ç–æ—Ä</a>
            </th>
            <th class="sort-col {% if current_sort == 'total_sum' %}{{ current_dir }}{% endif %}" style="width:100px;">
              <a href="?{% query_transform sort='total_sum' dir=rev_dir agreement=request.GET.agreement %}">–°—É–º–º–∞</a>
            </th>
            <th style="width:70px;"></th>
          </tr>
        </thead>
        <tbody>
        {% for a in agreements %}
          <tr class="double-click-row {% if current_agreement and a.id == current_agreement.id %}table-primary{% endif %}" 
              data-agreement-id="{{ a.id }}" 
              ondblclick="toggleExpand('agreement-{{ a.id }}')">
            <td>
              <div class="d-flex align-items-center">
                <a href="?{% query_transform agreement=a.id %}" 
                   onclick="event.stopPropagation();" 
                   style="text-decoration: none;">
                  {{ a.id }}
                </a>
              </div>
              <!-- –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–æ–µ –æ–∫–Ω–æ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É -->
              <div id="agreement-{{ a.id }}" class="expandable-window">
                <div class="detail-section">
                  <h6>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–≥–æ–≤–æ—Ä–µ</h6>
                  <div class="detail-row">
                    <span class="detail-label">–ö–æ–¥ –¥–æ–≥–æ–≤–æ—Ä–∞:</span>
                    <span class="detail-value">{{ a.agreement_code }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">–î–∞—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞:</span>
                    <span class="detail-value">{{ a.agreement_date|date:"d.m.Y H:i" }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">–¢–∏–ø –¥–æ–≥–æ–≤–æ—Ä–∞:</span>
                    <span class="detail-value">{{ a.get_agreement_type_display }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">–ö—Ä–µ–¥–∏—Ç–æ—Ä:</span>
                    <span class="detail-value">{{ a.creditor }}</span>
                  </div>
                  {% if a.creditor_first %}
                  <div class="detail-row">
                    <span class="detail-label">–ü–µ—Ä–≤. –∫—Ä–µ–¥–∏—Ç–æ—Ä:</span>
                    <span class="detail-value">{{ a.creditor_first }}</span>
                  </div>
                  {% endif %}
                  <div class="detail-row">
                    <span class="detail-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—è:</span>
                    <span class="detail-value currency-format">{{ a.total_sum|currency_format }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">–†–∞–∑–º–µ—Ä –ø–æ—Ä—Ç—Ñ–µ–ª—è:</span>
                    <span class="detail-value currency-format">{{ a.total_amount|currency_format }}</span>
                  </div>
                  {% if a.agreement_doc %}
                  <div class="detail-row">
                    <span class="detail-label">–î–æ–∫—É–º–µ–Ω—Ç:</span>
                    <span class="detail-value">
                      <a href="{{ a.agreement_doc.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                        üìé –°–∫–∞—á–∞—Ç—å
                      </a>
                    </span>
                  </div>
                  {% endif %}
                </div>
                
                <div class="action-buttons">
                  <a href="{% url 'deals:agreement-edit' a.pk %}" class="btn btn-primary btn-sm me-2">
                    ‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                  </a>
                  <a href="{% url 'deals:agreement-delete' a.pk %}" class="btn btn-outline-danger btn-sm">
                    üóë –£–¥–∞–ª–∏—Ç—å
                  </a>
                </div>
              </div>
            </td>
            <td><a href="?{% query_transform agreement=a.id %}" onclick="event.stopPropagation();">{{ a.agreement_code }}</a></td>
            <td><a href="?{% query_transform agreement=a.id %}" onclick="event.stopPropagation();">{{ a.agreement_date|date:"d.m.Y" }}</a></td>
            <td><a href="?{% query_transform agreement=a.id %}" onclick="event.stopPropagation();">{{ a.get_agreement_type_display }}</a></td>
            <td><a href="?{% query_transform agreement=a.id %}" onclick="event.stopPropagation();">{{ a.creditor }}</a></td>
            <td><a href="?{% query_transform agreement=a.id %}" onclick="event.stopPropagation();" class="currency-format">{{ a.total_sum|currency_format }}</a></td>
            <td>
              <a class="btn btn-sm btn-outline-secondary edit-btn" href="{% url 'deals:agreement-edit' a.pk %}" onclick="event.stopPropagation();">‚úé</a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="7" class="text-center">–ù–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–æ–≤</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨: –ü–æ—Ä—Ç—Ñ–µ–ª–∏ (1/3 —à–∏—Ä–∏–Ω—ã) -->
  <div class="panel-right">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">–ü–æ—Ä—Ç—Ñ–µ–ª–∏ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É ‚Ññ{{ current_agreement.id|default:"" }}</h5>
      {% if current_agreement %}
        <a class="btn btn-sm btn-success" href="{% url 'deals:portfolio-new' current_agreement.pk %}">+ –ü–æ—Ä—Ç—Ñ–µ–ª—å</a>
      {% endif %}
    </div>

    {% if current_agreement %}
      {% for p in current_agreement.portfolio_set.all %}
        <div class="card mb-3">
          <div class="single-click-header card-header" 
               onclick="toggleExpand('portfolio-{{ p.id }}')"
               title="–ö–ª–∏–∫ - –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0">
                {{ p.label|default:"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }}
              </h6>
              <span class="expand-toggle" id="portfolio-toggle-{{ p.id }}">
                –ü–æ–¥—Ä–æ–±–Ω–æ
              </span>
            </div>
          </div>
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <span class="badge bg-info text-dark mb-1">{{ p.get_type_display }}</span>
                <div class="small text-muted">
                  –°—É–º–º–∞: {{ p.total_sum|currency_format }}<br>
                  –°—Ç–∞—Ä—Ç: {{ p.date_placement|date:"d.m.Y" }}
                </div>
              </div>
              <a class="btn btn-sm btn-outline-primary edit-btn" href="{% url 'deals:portfolio-edit' p.pk %}">‚úé</a>
            </div>
          </div>
          
          <!-- –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ—Ä—Ç—Ñ–µ–ª—è -->
          <div id="portfolio-{{ p.id }}" class="expandable-window">
            <div class="detail-section">
              <h6>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ—Ä—Ç—Ñ–µ–ª–µ</h6>
              <div class="detail-row">
                <span class="detail-label">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</span>
                <span class="detail-value">{{ p.label|default:"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">–¢–∏–ø:</span>
                <span class="detail-value">{{ p.get_type_display }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">–¢–∏–ø —Ä–∞–±–æ—Ç—ã:</span>
                <span class="detail-value">{{ p.get_process_type_display }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">–°—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                <span class="detail-value currency-format">{{ p.total_sum|currency_format }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</span>
                <span class="detail-value">{{ p.date_placement|date:"d.m.Y" }}</span>
              </div>
              {% if p.date_finish %}
              <div class="detail-row">
                <span class="detail-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</span>
                <span class="detail-value">{{ p.date_finish|date:"d.m.Y" }}</span>
              </div>
              {% endif %}
              {% if p.cession_date %}
              <div class="detail-row">
                <span class="detail-label">–î–∞—Ç–∞ –ø–µ—Ä–µ—É—Å—Ç—É–ø–∫–∏:</span>
                <span class="detail-value">{{ p.cession_date|date:"d.m.Y" }}</span>
              </div>
              {% endif %}
            </div>
            
            <div class="action-buttons">
              <a href="{% url 'deals:portfolio-edit' p.pk %}" class="btn btn-primary btn-sm me-2">
                ‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
              </a>
              <a href="{% url 'deals:portfolio-delete' p.pk %}" class="btn btn-outline-danger btn-sm">
                üóë –£–¥–∞–ª–∏—Ç—å
              </a>
            </div>
          </div>
        </div>
      {% empty %}
        <p class="text-muted">–ù–µ—Ç –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π</p>
      {% endfor %}
    {% else %}
      <p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–≥–æ–≤–æ—Ä —Å–ª–µ–≤–∞</p>
    {% endif %}
  </div>
</div>

<script>
// –î–ª—è –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π - –æ–¥–∏–Ω–∞—Ä–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ
function toggleExpand(elementId) {
    const element = document.getElementById(elementId);
    const toggle = element.id.includes('portfolio-') ? 
                   document.getElementById('portfolio-toggle-' + elementId.replace('portfolio-', '')) :
                   null;
    
    if (element.classList.contains('show')) {
        element.classList.remove('show');
        if (toggle) toggle.textContent = '–ü–æ–¥—Ä–æ–±–Ω–æ';
    } else {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –æ–∫–Ω–∞
        document.querySelectorAll('.expandable-window.show').forEach(el => {
            el.classList.remove('show');
        });
        document.querySelectorAll('.expand-toggle').forEach(el => {
            if (el !== toggle) el.textContent = '–ü–æ–¥—Ä–æ–±–Ω–æ';
        });
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –æ–∫–Ω–æ
        element.classList.add('show');
        if (toggle) toggle.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
    }
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
setTimeout(function() {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(function(alert) {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
    });
}, 5000);
</script>

{% endblock %}