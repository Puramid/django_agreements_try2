{% extends 'base.html' %}
{% block title %}{{ view.object|default:"Новый объект" }}{% endblock %}
{% block content %}
<div class="container mt-5" style="max-width:600px;">
  <h3 class="mb-4">{{ view.object|default:"Новый объект" }}</h3>

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    {# --- read-only «итоговое» имя портфеля (для PortfolioForm) --- #}
    {% if form.label_preview %}
      <div class="mb-3">
        <label for="{{ form.label_preview.id_for_label }}" class="form-label">
          {{ form.label_preview.label }}
        </label>
        {{ form.label_preview }}
        {% if form.label_preview.help_text %}
          <div class="form-text">{{ form.label_preview.help_text }}</div>
        {% endif %}
      </div>
    {% endif %}

    {# --- остальные поля формы --- #}
    {% for field in form %}
      {% if field.name != 'label_preview' %}
        <div class="mb-3">
          <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
          {{ field }}
          {% if field.help_text %}
            <div class="form-text">{{ field.help_text }}</div>
          {% endif %}
          {% if field.errors %}
            <div class="text-danger small">{{ field.errors|join:", " }}</div>
          {% endif %}
        </div>
      {% endif %}
    {% endfor %}

    {# --- кнопки --- #}
    <button type="submit" class="btn btn-primary me-2">Сохранить</button>

    {% if view.object %}
      <a href="
        {% if 'agreement' in request.path %}
          {% url 'deals:agreement-delete' view.object.pk %}
        {% else %}
          {% url 'deals:portfolio-delete' view.object.pk %}
        {% endif %}
      " class="btn btn-outline-danger me-2">Удалить</a>
    {% endif %}

    <a href="{% url 'deals:dashboard' %}" class="btn btn-secondary">Отмена</a>
  </form>
</div>

{# --- скрипт для динамического расчёта label_preview --- #}
<script>
(function () {
    const typeSel      = document.querySelector('#id_type');
    const processSel   = document.querySelector('#id_process_type');
    const dateInput    = document.querySelector('#id_date_placement');
    const previewInput = document.querySelector('#id_label_preview');

    if (!previewInput) return;  // не форма портфеля

    const creditorName = "{{ view.agreement.creditor.name|default:'Кредитор' }}";

    function buildLabel() {
        const typeText    = typeSel?.selectedOptions[0]?.text    || '';
        const processText = processSel?.selectedOptions[0]?.text || '';
        const dateVal     = dateInput?.value;
        const dateFmt     = dateVal ? new Date(dateVal).toLocaleDateString('ru-RU') : '';
        const label       = `${creditorName}_${typeText}_${dateFmt}_${processText}`;
        previewInput.value = label;
    }

    // первичный расчёт и слушатели
    document.addEventListener('DOMContentLoaded', buildLabel);
    [typeSel, processSel, dateInput].forEach(el => {
        el && el.addEventListener('change', buildLabel);
        el && el.addEventListener('input',  buildLabel);
    });
})();
</script>
{% endblock %}