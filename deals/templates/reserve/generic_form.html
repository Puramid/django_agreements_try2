{% extends 'base.html' %}
{% load humanize %}
{% block title %}{{ view.object|default:"Новый объект" }}{% endblock %}
{% block content %}
<div class="container mt-5" style="max-width:600px;">
  <h3 class="mb-4">
    {% if view.object %}
      {% if view.object.agreement_code %}
        Редактирование договора №{{ view.object.id }}
      {% else %}
        Редактирование портфеля: {{ view.object.label|default:"Без названия" }}
      {% endif %}
    {% else %}
      {% if 'agreement' in request.path %}
        Новый договор
      {% else %}
        Новый портфель
      {% endif %}
    {% endif %}
  </h3>

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    {# --- read-only «итоговое» имя портфеля (для PortfolioForm) --- #}
    {% if form.label_preview %}
      <div class="mb-3">
        <label for="{{ form.label_preview.id_for_label }}" class="form-label">
          {{ form.label_preview.label }}
        </label>
        {{ form.label_preview }}
      </div>
    {% endif %}

    {# --- остальные поля формы --- #}
    {% for field in form %}
      {% if field.name != 'label_preview' %}
        <div class="mb-3">
          <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
          
          {% if field.name == 'total_sum' or field.name == 'total_amount' %}
            <div class="input-group">
              {{ field }}
              <span class="input-group-text">₽</span>
            </div>
          {% else %}
            {{ field }}
          {% endif %}
          
          {% if field.help_text %}
            <div class="form-text">{{ field.help_text }}</div>
          {% endif %}
          {% if field.errors %}
            <div class="text-danger small">{{ field.errors|join:", " }}</div>
          {% endif %}
          
          {# Показываем текущее значение для дат при редактировании #}
          {% if view.object and field.name in 'date_placement,date_finish,cession_date,agreement_date' %}
            <div class="form-text text-muted">
              Текущее значение: 
              {% if field.name == 'agreement_date' and view.object.agreement_date %}
                {{ view.object.agreement_date|date:"d.m.Y H:i" }}
              {% elif field.name == 'date_placement' and view.object.date_placement %}
                {{ view.object.date_placement|date:"d.m.Y" }}
              {% elif field.name == 'date_finish' and view.object.date_finish %}
                {{ view.object.date_finish|date:"d.m.Y" }}
              {% elif field.name == 'cession_date' and view.object.cession_date %}
                {{ view.object.cession_date|date:"d.m.Y" }}
              {% endif %}
            </div>
          {% endif %}
        </div>
      {% endif %}
    {% endfor %}

    {# --- скрытое поле для agreement при создании портфеля --- #}
    {% if 'portfolio' in request.path and 'new' in request.path %}
      <input type="hidden" name="agreement" value="{{ agreement.id }}">
    {% endif %}

    {# --- кнопки --- #}
    <button type="submit" class="btn btn-primary me-2">
      {% if view.object %}Отредактировать{% else %}Создать{% endif %}
    </button>

    {% if view.object %}
      <a href="
        {% if 'agreement' in request.path %}
          {% url 'deals:agreement-delete' view.object.pk %}
        {% else %}
          {% url 'deals:portfolio-delete' view.object.pk %}
        {% endif %}
      " class="btn btn-outline-danger me-2">Удалить</a>
    {% endif %}

    <a href="{% url 'deals:dashboard' %}" class="btn btn-secondary">Отмена</a>
  </form>
</div>

{# --- скрипт для динамического расчёта label_preview --- #}
<script>
(function () {
    const typeSel      = document.querySelector('#id_type');
    const processSel   = document.querySelector('#id_process_type');
    const dateInput    = document.querySelector('#id_date_placement');
    const previewInput = document.querySelector('#id_label_preview');

    if (!previewInput) return;  // не форма портфеля

    const creditorName = "{{ agreement.creditor.name|default:'Кредитор' }}";

    function buildLabel() {
        const typeText    = typeSel?.selectedOptions[0]?.text    || '';
        const processText = processSel?.selectedOptions[0]?.text || '';
        const dateVal     = dateInput?.value;
        
        let dateFmt = '';
        if (dateVal) {
            const date = new Date(dateVal);
            dateFmt = date.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        const label = `${creditorName}_${typeText}_${dateFmt}_${processText}`;
        previewInput.value = label;
    }

    // первичный расчёт и слушатели
    document.addEventListener('DOMContentLoaded', buildLabel);
    [typeSel, processSel, dateInput].forEach(el => {
        el && el.addEventListener('change', buildLabel);
        el && el.addEventListener('input',  buildLabel);
    });
})();
</script>
{% endblock %}