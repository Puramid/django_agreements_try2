{% extends 'base.html' %} 
{% load static humanize custom_filters %} 
{% load query_transform %} 
{% block title %}ECOI{% endblock %} 
{% block content %} 
{% if messages %} 
{% for message in messages %} 
<div class="alert alert-info">{{ message }}</div> 
{% endfor %} 
{% endif %} 

<div class="dashboard-container">
  <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –°–ø–∏—Å–æ–∫ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ -->
  <div class="agreements-panel">
    <div class="panel-header">
      <h3>–î–æ–≥–æ–≤–æ—Ä—ã</h3>
      <a href="{% url 'credits:agreement-new' %}" class="btn btn-primary btn-sm">+ –ù–æ–≤—ã–π</a>
    </div>
    
    <div class="agreements-list">
      {% for a in agreements %}
      <div class="agreement-item {% if a == current_agreement %}active{% endif %}" data-agreement-id="{{ a.id }}">
        <div class="agreement-main">
          <div class="agreement-info">
            <div class="agreement-code">{{ a.agreement_code }}</div>
            <div class="agreement-meta">
              <span class="agreement-id">ID: {{ a.id }}</span>
              <span class="creditor-name">{{ a.creditor }}</span>
              <span>{{ a.agreement_date|date:"d.m.Y" }}</span>
              <span>{{ a.get_agreement_type_display }}</span>
              <span class="financial-info">–°—É–º–º–∞: {{ a.total_sum|currency_format }}</span>
              <span class="financial-info">–°—Ç–æ–∏–º–æ—Å—Ç—å: {{ a.total_amount|currency_format }}</span>
            </div>
          </div>
          <div class="agreement-actions">
            <a href="?agreement={{ a.id }}" class="view-btn">üëÅ</a>
            <a href="{% url 'credits:agreement-edit' a.id %}" class="edit-btn">‚úé</a>
            <a href="{% url 'credits:agreement-delete' a.id %}" class="delete-btn">üóë</a>
          </div>
        </div>
        
        <!-- –°–∫—Ä—ã—Ç—ã–π –±–ª–æ–∫ —Å –¥–µ—Ç–∞–ª—è–º–∏ -->
        <div class="agreement-details" id="details-{{ a.id }}">
          <div class="detail-row">
            <strong>–ö–æ–¥ –¥–æ–≥–æ–≤–æ—Ä–∞:</strong> {{ a.agreement_code }}
          </div>
          <div class="detail-row">
            <strong>ID –¥–æ–≥–æ–≤–æ—Ä–∞:</strong> {{ a.id }}
          </div>
          <div class="detail-row">
            <strong>–î–∞—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞:</strong> {{ a.agreement_date|date:"d.m.Y" }}
          </div>
          <div class="detail-row">
            <strong>–¢–∏–ø –¥–æ–≥–æ–≤–æ—Ä–∞:</strong> {{ a.get_agreement_type_display }}
          </div>
          <div class="detail-row">
            <strong>–ö—Ä–µ–¥–∏—Ç–æ—Ä:</strong> {{ a.creditor }}
          </div>
          {% if a.creditor_first %}
          <div class="detail-row">
            <strong>–ü–µ—Ä–≤. –∫—Ä–µ–¥–∏—Ç–æ—Ä:</strong> {{ a.creditor_first }}
          </div>
          {% endif %}
          <div class="detail-row">
            <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—è:</strong> {{ a.total_sum|currency_format }}
          </div>
          <div class="detail-row">
            <strong>–†–∞–∑–º–µ—Ä –ø–æ—Ä—Ç—Ñ–µ–ª—è:</strong> {{ a.total_amount|currency_format }}
          </div>
          {% if a.agreement_doc %}
          <div class="detail-row">
            <strong>–î–æ–∫—É–º–µ–Ω—Ç:</strong> <a href="{{ a.agreement_doc.url }}">üìé –°–∫–∞—á–∞—Ç—å</a>
          </div>
          {% endif %}
        </div>
      </div>
      {% empty %}
      <div class="no-data">–ù–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–æ–≤</div>
      {% endfor %}
    </div>
  </div>

  <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –ü–æ—Ä—Ç—Ñ–µ–ª–∏ -->
  <div class="portfolios-panel">
    <div class="panel-header">
      <!-- –ò–∑–º–µ–Ω–µ–Ω–æ: –≤–º–µ—Å—Ç–æ –Ω–æ–º–µ—Ä–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–¥ –¥–æ–≥–æ–≤–æ—Ä–∞ -->
      <h3>–ü–æ—Ä—Ç—Ñ–µ–ª–∏ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É {% if current_agreement %}({{ current_agreement.agreement_code }}){% else %}(–Ω–µ –≤—ã–±—Ä–∞–Ω){% endif %}</h3>
      {% if current_agreement %}
      <a href="{% url 'credits:portfolio-new' current_agreement.id %}" class="btn btn-primary btn-sm">+ –ü–æ—Ä—Ç—Ñ–µ–ª—å</a>
      {% endif %}
    </div>
    
    <div class="portfolios-list">
      {% if current_agreement %}
      {% for p in current_agreement.portfolio_set.all %}
      <div class="portfolio-item">
        <div class="portfolio-header">
          <div class="portfolio-title">{{ p.label|default:"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }}</div>
          <div class="portfolio-actions">
            <a href="{% url 'credits:portfolio-edit' p.id %}" class="edit-btn">‚úé</a>
            <a href="{% url 'credits:portfolio-delete' p.id %}" class="delete-btn">üóë</a>
          </div>
        </div>
        
        <div class="portfolio-info">
          <div class="info-row">
            <span>ID:</span> {{ p.id }}
          </div>
          <div class="info-row">
            <span>–¢–∏–ø:</span> {{ p.get_type_display }}
          </div>
          <div class="info-row">
            <span>–°—É–º–º–∞:</span> {{ p.total_sum|currency_format }}
          </div>
          <div class="info-row">
            <span>–°—Ç–∞—Ä—Ç:</span> {{ p.date_placement|date:"d.m.Y" }}
          </div>
          {% if p.date_finish %}
          <div class="info-row">
            <span>–û–∫–æ–Ω—á–∞–Ω–∏–µ:</span> {{ p.date_finish|date:"d.m.Y" }}
          </div>
          {% endif %}
        </div>
        
        <button class="toggle-details" data-target="portfolio-details-{{ p.id }}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
        
        <div id="portfolio-details-{{ p.id }}" class="portfolio-details" style="display: none;">
          <div class="detail-row">
            <strong>ID:</strong> {{ p.id }}
          </div>
          <div class="detail-row">
            <strong>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</strong> {{ p.label|default:"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }}
          </div>
          <div class="detail-row">
            <strong>–¢–∏–ø:</strong> {{ p.get_type_display }}
          </div>
          <div class="detail-row">
            <strong>–¢–∏–ø —Ä–∞–±–æ—Ç—ã:</strong> {{ p.get_process_type_display }}
          </div>
          <div class="detail-row">
            <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> {{ p.total_sum|currency_format }}
          </div>
          <div class="detail-row">
            <strong>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</strong> {{ p.date_placement|date:"d.m.Y" }}
          </div>
          {% if p.date_finish %}
          <div class="detail-row">
            <strong>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</strong> {{ p.date_finish|date:"d.m.Y" }}
          </div>
          {% endif %}
          {% if p.cession_date %}
          <div class="detail-row">
            <strong>–î–∞—Ç–∞ –ø–µ—Ä–µ—É—Å—Ç—É–ø–∫–∏:</strong> {{ p.cession_date|date:"d.m.Y" }}
          </div>
          {% endif %}
        </div>
      </div>
      {% empty %}
      <div class="no-data">–ù–µ—Ç –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π</div>
      {% endfor %}
      {% else %}
      <div class="no-data">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–≥–æ–≤–æ—Ä —Å–ª–µ–≤–∞</div>
      {% endif %}
    </div>
  </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –¥–æ–≥–æ–≤–æ—Ä–∞–º
        const agreementItems = document.querySelectorAll('.agreement-item');
        
        agreementItems.forEach(item => {
            item.addEventListener('click', function(e) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ –∫–Ω–æ–ø–∫–∞–º –¥–µ–π—Å—Ç–≤–∏–π
                if (e.target.closest('.agreement-actions')) return;
                
                const agreementId = this.dataset.agreementId;
                const detailsBlock = document.getElementById(`details-${agreementId}`);
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –¥–µ—Ç–∞–ª–µ–π
                if (detailsBlock.style.display === 'block') {
                    detailsBlock.style.display = 'none';
                } else {
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –¥–µ—Ç–∞–ª–∏
                    document.querySelectorAll('.agreement-details').forEach(detail => {
                        detail.style.display = 'none';
                    });
                    
                    detailsBlock.style.display = 'block';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä
                agreementItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                const url = new URL(window.location);
                url.searchParams.set('agreement', agreementId);
                window.history.pushState({}, '', url);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
                updatePortfoliosPanel(agreementId);
            });
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ "–ü–æ–¥—Ä–æ–±–Ω–µ–µ" –¥–ª—è –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
        const toggleButtons = document.querySelectorAll('.toggle-details');
        
        toggleButtons.forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const detailsBlock = document.getElementById(targetId);
                
                if (detailsBlock.style.display === 'block') {
                    detailsBlock.style.display = 'none';
                    this.textContent = '–ü–æ–¥—Ä–æ–±–Ω–µ–µ';
                } else {
                    detailsBlock.style.display = 'block';
                    this.textContent = '–°–∫—Ä—ã—Ç—å';
                }
            });
        });
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
        function updatePortfoliosPanel(agreementId) {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å AJAX-–∑–∞–ø—Ä–æ—Å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
            // –í –¥–∞–Ω–Ω–æ–º –ø—Ä–∏–º–µ—Ä–µ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            window.location.href = `?agreement=${agreementId}`;
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const currentAgreementId = new URLSearchParams(window.location.search).get('agreement');
        if (currentAgreementId) {
            const activeItem = document.querySelector(`.agreement-item[data-agreement-id="${currentAgreementId}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞
                const detailsBlock = document.getElementById(`details-${currentAgreementId}`);
                if (detailsBlock) {
                    detailsBlock.style.display = 'block';
                }
            }
        }
        
        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è –≤ —Ñ–æ—Ä–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const portfolioForm = document.getElementById('portfolio-form');
        if (portfolioForm) {
            const datePlacementField = document.querySelector('#id_date_placement');
            const processTypeField = document.querySelector('#id_process_type');
            const labelPreview = document.querySelector('#portfolio-label-preview');
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä–∞
            let creditor, agreementType;
            
            // –î–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è –±–µ—Ä–µ–º –∏–∑ —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π
            if (document.querySelector('#agreement-creditor')) {
                creditor = document.querySelector('#agreement-creditor').value;
                agreementType = document.querySelector('#agreement-type').value;
            } 
            // –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è –±–µ—Ä–µ–º –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            else if (labelPreview) {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∏–º–µ–Ω–∏
                const currentLabel = labelPreview.textContent;
                const parts = currentLabel.split('_');
                if (parts.length >= 4) {
                    creditor = parts[0];
                    agreementType = parts[1];
                }
            }
            
            // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–º–µ–Ω–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è
            function updatePortfolioLabel() {
                if (!datePlacementField || !processTypeField || !creditor || !agreementType) return;
                
                const datePlacement = datePlacementField.value ? 
                    new Date(datePlacementField.value).toLocaleDateString('ru-RU') : '';
                const processType = processTypeField.options[processTypeField.selectedIndex]?.text || '';
                
                const newLabel = `${creditor}_${agreementType}_${datePlacement}_${processType}`;
                if (labelPreview) {
                    labelPreview.textContent = newLabel;
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            if (datePlacementField) {
                datePlacementField.addEventListener('change', updatePortfolioLabel);
                datePlacementField.addEventListener('input', updatePortfolioLabel);
            }
            if (processTypeField) {
                processTypeField.addEventListener('change', updatePortfolioLabel);
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            updatePortfolioLabel();
        }
    });
</script>
{% endblock %}